name: Auto Release PR

on:
  push:
    branches:
      - develop

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release-pr:
    name: Create Release PR from develop to master
    runs-on: ubuntu-latest

    # åªåœ¨ develop push æ—¶è¿è¡Œï¼ˆå¤šä¸€å±‚ä¿æŠ¤ï¼‰
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: Checkout current commit (develop push)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # â­ ä½¿ç”¨è¿™æ¬¡ push çš„å®žé™… commitï¼Œè€Œä¸æ˜¯â€œæŸä¸ªåˆ†æ”¯çŠ¶æ€â€
          ref: ${{ github.sha }}

      - name: Show HEAD & branches (debug)
        run: |
          echo "Current branch:"
          git branch --show-current || echo "(detached HEAD)"
          echo "HEAD commit:"
          git log -1 --oneline || true

      # ä¸å†åšä»»ä½• diff åˆ¤æ–­ï¼Œæ°¸è¿œå¼ºåˆ¶åŒæ­¥ release åˆ†æ”¯ = å½“å‰ HEAD (develop)
      - name: Prepare release branch from develop
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # â­ å¼ºåˆ¶è®© release/auto-release æŒ‡å‘å½“å‰ HEADï¼ˆå³ develop çš„è¿™æ¬¡æäº¤ï¼‰
          git checkout -B release/auto-release ${{ github.sha }}

          echo "Auto release updated at $(date)" > RELEASE_NOTES.md
          git add RELEASE_NOTES.md
          git commit -m "chore: update auto release notes" || echo "Nothing to commit"

      - name: Push release branch
        run: git push -f origin release/auto-release

      - name: Create or Update Release PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: master
          branch: release/auto-release
          title: "Release: Next Version"
          labels: |
            automated
            release
          body: |
            ## ðŸš€ Auto Release PR (develop â†’ master)

            This PR prepares the next production release.

            This branch is force-synced from the latest commit on **develop**.

            HEAD commit:

            ```bash
            $(git log -1 --oneline)
            ```
