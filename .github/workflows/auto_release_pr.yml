name: Auto Release PR (develop â†’ release/auto-release)

on:
  push:
    branches:
      - develop      # develop æœ‰ä»»ä½• pushï¼ˆåŒ…æ‹¬ mergeï¼‰éƒ½è§¦å‘

permissions:
  contents: write
  pull-requests: write

jobs:
  # -------------------------------------------------------------
  # 1) è¿è¡Œ CI â€”â€” å¼ºåˆ¶å¿…é¡»é€šè¿‡æ‰ç»§ç»­æ‰§è¡Œ auto release
  # -------------------------------------------------------------
  run-ci:
    uses: ./.github/workflows/ci.yaml
    secrets: inherit

  # -------------------------------------------------------------
  # 2) åˆ›å»º auto release åˆ†æ”¯ + åˆ›å»ºä¸¤ä¸ª PR
  # -------------------------------------------------------------
  create_auto_release_pr:
    needs: run-ci
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 1 â€” åˆ›å»º release/auto-release åˆ†æ”¯
      - name: Create auto-release branch
        run: |
          git fetch origin
          git checkout -B release/auto-release origin/develop
          git push origin release/auto-release --force

      # Step 2 â€” åˆ›å»º develop â†’ release/auto-release PR
      - name: Create PR from develop â†’ release/auto-release
        uses: repo-sync/pull-request@v2
        with:
          source_branch: develop
          destination_branch: release/auto-release
          github_token: ${{ secrets.GITHUB_TOKEN }}
          pr_title: "chore(release): Auto release preparation"
          pr_body: "Auto-generated PR to prepare release branch"
          pr_label: "auto-release"

      # ---------------------------------------------------------
      # Step 3 â€” ç”Ÿæˆæœ€ç»ˆ release notes + pull_request_template.md åˆå¹¶
      # ---------------------------------------------------------
      - name: Generate PR Body (Notes + Template)
        id: prbody
        run: |
          echo "â³ Generating PR body..."

          # è‡ªåŠ¨ç”Ÿæˆ commits åˆ—è¡¨
          NOTES=$(git log origin/master..origin/release/auto-release --pretty=format:"- %s" --reverse)

          # è¯»å– PR æ¨¡æ¿ï¼ˆæ‰‹åŠ¨ PR ä½¿ç”¨è¿™ä¸ªæ¨¡æ¿ï¼‰
          TEMPLATE=$(cat .github/pull_request_template.md)

          # åˆå¹¶æˆä¸€ä¸ªå®Œæ•´ PR å†…å®¹
          cat <<EOF > pr_body.txt
          ### ğŸ‰ Final Release Notes Before Publishing

          #### ğŸ“ Commits Included in This Release
          $NOTES

          ---

          $TEMPLATE
          EOF

          # è¾“å‡ºç»™ GitHub Actions
          {
            echo "body<<EOF"
            cat pr_body.txt
            echo "EOF"
          } >> $GITHUB_OUTPUT

      # ---------------------------------------------------------
      # Step 4 â€” è‡ªåŠ¨åˆ›å»º release/auto-release â†’ master PR
      # ---------------------------------------------------------
      - name: Create PR from release/auto-release â†’ master
        uses: repo-sync/pull-request@v2
        with:
          source_branch: release/auto-release
          destination_branch: master
          github_token: ${{ secrets.GITHUB_TOKEN }}
          pr_title: "chore(release): Release â†’ master"
          pr_body: ${{ steps.prbody.outputs.body }}
          pr_label: "release"
