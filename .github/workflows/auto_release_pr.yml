name: Auto Release PR

on:
  push:
    branches:
      - develop

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # ------------------------------------------------------------
      # ğŸ”¥ Step 1 â€” Force recreate release/auto-release from develop
      # ------------------------------------------------------------
      - name: Sync release/auto-release with develop
        run: |
          git fetch origin

          # ç¡®ä¿ develop æ˜¯æœ€æ–°çš„
          git checkout develop
          git pull origin develop

          # å¼ºåˆ¶åŒæ­¥ release åˆ†æ”¯ï¼ˆæ°¸è¿œä» develop æ¥ï¼‰
          git branch -f release/auto-release develop || true
          git push -f origin release/auto-release

      # ------------------------------------------------------------
      # ğŸ”¥ Step 2 â€” Create PR using GitHub API (gh)
      # ------------------------------------------------------------
      - name: Install GitHub CLI
        run: sudo apt-get install -y gh

      - name: Create Pull Request via GitHub API
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # æ£€æŸ¥æ˜¯å¦å·²æœ‰åŒå PR
          existing=$(gh pr list \
            --base master \
            --head release/auto-release \
            --state open \
            --json number \
            --jq '.[0].number // empty')

          if [ -n "$existing" ]; then
            echo "â„¹ï¸ PR already exists: #$existing"
            exit 0
          fi

          echo "âš¡ Creating PR: release/auto-release â†’ master"

          gh pr create \
            --title "Release: Next Version" \
            --body "Automated release PR from **release/auto-release** â†’ **master**." \
            --base master \
            --head release/auto-release \
            --label release
