name: Auto Release PR

on:
  push:
    branches:
      - develop

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release-pr:
    name: Create Release PR from develop to master
    runs-on: ubuntu-latest

    if: github.ref == 'refs/heads/develop'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch master
        run: git fetch origin master

      # 1ï¸âƒ£ æ£€æŸ¥ develop å’Œ master æ˜¯å¦æœ‰å·®å¼‚
      - name: Check diff between develop and master
        id: check_diff
        run: |
          # å½“å‰ HEAD æ˜¯ developï¼ˆå› ä¸º trigger æ˜¯ develop pushï¼‰
          if git diff --quiet origin/master..HEAD; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
          fi

      # å¦‚æœæ²¡æœ‰å·®å¼‚ï¼Œç›´æ¥é€€å‡ºï¼ˆä¸åˆ›å»º PRï¼‰
      - name: Stop on no changes
        if: steps.check_diff.outputs.no_changes == 'true'
        run: |
          echo "âšª No new changes between develop and master. Skipping auto release PR."
          exit 0

      # 2ï¸âƒ£ ç”Ÿæˆç®€å•ç‰ˆ Release Notesï¼ˆåŸºäº commit messageï¼‰
      - name: Generate release notes
        run: |
          echo "## ğŸš€ Next Release (develop â†’ master)" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "### Changes since last release:" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          git log origin/master..HEAD --pretty=format:"- %s" >> RELEASE_NOTES.md

      # 3ï¸âƒ£ å‡†å¤‡ release åˆ†æ”¯ï¼ˆå¼ºåˆ¶åŒæ­¥ä¸º develop HEADï¼Œå¹¶åŒ…å« RELEASE_NOTES.mdï¼‰
      - name: Prepare release branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # å¼ºåˆ¶åˆ›å»º/é‡ç½® release/auto-release = develop
          git checkout -B release/auto-release
          git reset --hard HEAD   # HEAD å³ develop

          git add RELEASE_NOTES.md
          git commit -m "chore: update auto release notes" || echo "Nothing to commit"

      # 4ï¸âƒ£ æ¨é€ release åˆ†æ”¯
      - name: Push release branch
        run: git push -f origin release/auto-release

      # 5ï¸âƒ£ åˆ›å»ºæˆ–æ›´æ–° PRï¼šrelease/auto-release â†’ master
      - name: Create or Update Release PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: master
          branch: release/auto-release
          title: "Release: Next Version"
          labels: |
            automated
            release
          body: |
            ## ğŸš€ Auto Release PR (develop â†’ master)

            This PR prepares the next production release.

            ### ğŸ“„ Changes included
            (auto generated from commits between master and develop)

            ```
            $(cat RELEASE_NOTES.md)
            ```
