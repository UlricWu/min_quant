name: Auto Release PR

on:
  push:
    branches:
      - develop

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release-pr:
    name: Create Release PR from develop to master
    runs-on: ubuntu-latest

    if: github.ref == 'refs/heads/develop'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch master
        run: git fetch origin master

      # ğŸ’¡ Step 1: æ£€æŸ¥ develop vs master æ˜¯å¦å­˜åœ¨å˜æ›´
      - name: Check diff
        id: check_diff
        run: |
          if git diff --quiet origin/master..HEAD; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
          else
            echo "no_changes=false" >> $GITHUB_OUTPUT
          fi

      # ğŸš€ æ²¡æœ‰å˜æ›´åˆ™å®Œå…¨è·³è¿‡ ï¼ˆé¿å…å‡ºç° up-to-date çš„å‡ PRï¼‰
      - name: Stop on no changes
        if: steps.check_diff.outputs.no_changes == 'true'
        run: |
          echo "âšª No new changes between develop and master. Skipping release PR."
          exit 0

      # ğŸ’¡ Step 2: ç”Ÿæˆè¯­ä¹‰åŒ– diffï¼ˆæ›´ç¨³å¥æ›´çœŸå®ï¼‰
      - name: Generate release notes
        run: |
          echo "## ğŸš€ Next Release" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          echo "### ğŸ” Changes since last release:" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          # åˆ†ç±»è¾“å‡º
          echo "#### âœ¨ Features" >> RELEASE_NOTES.md
          git log origin/master..HEAD --pretty=format:"- %s" | grep "^feat" || echo "- (none)" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          echo "#### ğŸ Fixes" >> RELEASE_NOTES.md
          git log origin/master..HEAD --pretty=format:"- %s" | grep "^fix" || echo "- (none)" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          echo "#### ğŸ”§ Refactor" >> RELEASE_NOTES.md
          git log origin/master..HEAD --pretty=format:"- %s" | grep "^refactor" || echo "- (none)" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          echo "#### ğŸ“š Docs" >> RELEASE_NOTES.md
          git log origin/master..HEAD --pretty=format:"- %s" | grep "^docs" || echo "- (none)" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          echo "#### ğŸ§¹ Chore" >> RELEASE_NOTES.md
          git log origin/master..HEAD --pretty=format:"- %s" | grep "^chore" || echo "- (none)" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

      # ğŸ’¡ Step 3: åˆ›å»º release åˆ†æ”¯
      - name: Prepare release branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -B release/auto-release
          git add RELEASE_NOTES.md
          git commit -m "chore: update auto release notes" || echo "Nothing to commit"

      # ğŸ’¡ Step 4: æ¨é€åˆ†æ”¯
      - name: Push release branch
        run: git push -f origin release/auto-release

      # ğŸ’¡ Step 5: åˆ›å»ºæˆ–æ›´æ–° PR
      - name: Create or Update Release PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: master
          branch: release/auto-release
          title: "Release: Next Version"
          labels: |
            automated
            release
          body: |
            ## ğŸš€ Auto Release PR (develop â†’ master)

            This PR prepares the next release.

            ### ğŸ“„ Changes included
            (auto generated below)

            ```
            $(cat RELEASE_NOTES.md)
            ```
