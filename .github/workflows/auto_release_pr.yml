name: Auto Release PR (develop â†’ release/auto-release)

#on:
#  workflow_run:
#    workflows: ["CI"]        # â­ å½“ CI å®Œæˆæ—¶è§¦å‘
#    types:
#      - completed

on:
  push:
    branches:
      - develop

permissions:
  contents: write
  pull-requests: write

jobs:
  create_auto_release_pr:
    runs-on: ubuntu-latest

    steps:
      - run-ci:
        uses: ./.github/workflows/ci.yaml   # å¼•ç”¨ä½ ç°æœ‰çš„ CI æ–‡ä»¶
        secrets: inherit                   # ç»§æ‰¿ secrets


      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      # STEP 1: åˆ›å»ºå¹¶ push release/auto-release åˆ†æ”¯
      - name: Create auto-release branch
        run: |
          git fetch origin
          git checkout -B release/auto-release origin/develop
          git push origin release/auto-release --force

      # STEP 2: åˆ›å»º develop â†’ release/auto-release PR
      - name: Create PR from develop â†’ release/auto-release
        uses: repo-sync/pull-request@v2
        with:
          source_branch: develop
          destination_branch: release/auto-release
          github_token: ${{ secrets.GITHUB_TOKEN }}
          pr_title: "chore(release): Auto release preparation"
          pr_body: |
            This PR is auto-generated from develop.
            It prepares the release branch.
          pr_label: "auto-release"

      - name: Generate Final Release Notes
        id: final_notes
        run: |
            echo "Generating final release notes..."
            
            NOTES=$(git log origin/master..origin/release/auto-release --pretty=format:"- %s" --reverse)
            
            cat <<EOF > final_notes.txt
            ### ğŸ‰ Final Release Notes Before Publishing
      
            #### ğŸ“ Commits Included in This Release
            $NOTES
      
            #### ğŸ“Œ Next Steps
            After merging this PR into **master**, semantic-release will:
      
              - Automatically determine version bump (major/minor/patch)
              - Generate CHANGELOG.md
              - Create GitHub Release & Tag
              - Publish artifacts (if configured)
      
            EOF
            
            echo "::set-output name=body::$(cat final_notes.txt)"

      # STEP 3: åˆ›å»º release/auto-release â†’ master PRï¼ˆä½ éœ€è¦çš„ï¼‰
      - name: Create PR from release/auto-release â†’ master
        uses: repo-sync/pull-request@v2
        with:
          source_branch: release/auto-release
          destination_branch: master
          github_token: ${{ secrets.GITHUB_TOKEN }}
          pr_title: "chore(release): Release â†’ master"
          pr_body: ${{ steps.final_notes.outputs.body }}
          pr_label: "release"
