name: Auto Release PR (develop â†’ release/auto-release)

on:
  push:
    branches:
      - develop

permissions:
  contents: write
  pull-requests: write

jobs:
  run-ci:
    uses: ./.github/workflows/ci.yaml   # å¼•ç”¨ä½ ç°æœ‰çš„ CI æ–‡ä»¶
    secrets: inherit                   # ç»§æ‰¿ secrets

  create_auto_release_pr:
    needs: run-ci                      # CI å¿…é¡»æˆåŠŸåæ‰æ‰§è¡Œ
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------------
      # STEP 0: Load PR Template (.github/pull_request_template.md)
      # --------------------------------------------------------
      - name: Load PR template
        id: pr_template
        run: |
          echo "Reading PR template..."
          body=$(cat .github/pull_request_template.md)

          # Escape characters for GitHub output
          body="${body//'%'/'%25'}"
          body="${body//$'\n'/'%0A'}"
          body="${body//$'\r'/'%0D'}"

          echo "template_body=$body" >> $GITHUB_OUTPUT
      # STEP 1: åˆ›å»ºå¹¶ push release/auto-release åˆ†æ”¯
      - name: Create auto-release branch
        run: |
          git fetch origin
          git checkout -B release/auto-release origin/develop
          git push origin release/auto-release --force
          

      - name: Generate Final Release Notes
        id: final_notes
        run: |
          echo "Generating final release notes..."
          
          NOTES=$(git log origin/master..origin/release/auto-release --pretty=format:"- %s" --reverse)
          
          cat <<EOF > final_notes.txt
          ### ğŸ‰ Final Release Notes Before Publishing
          
          #### ğŸ“ Commits Included in This Release
          $NOTES
          
          #### ğŸ“Œ Next Steps
          After merging this PR into **master**, semantic-release will:
          
            - Automatically determine version bump (major/minor/patch)
            - Generate CHANGELOG.md
            - Create GitHub Release & Tag
            - Publish artifacts (if configured)
          
          EOF
          
          BODY=$(cat final_notes.txt)

          # Escape for GitHub Output
          BODY="${BODY//'%'/'%25'}"
          BODY="${BODY//$'\n'/'%0A'}"
          BODY="${BODY//$'\r'/'%0D'}"
          
          echo "::set-output name=body::$(cat final_notes.txt)"

      # STEP 2: åˆ›å»º develop â†’ release/auto-release PR
      - name: Create PR from develop â†’ release/auto-release
        uses: repo-sync/pull-request@v2
        with:
          source_branch: develop
          destination_branch: release/auto-release
          github_token: ${{ secrets.GITHUB_TOKEN }}
          pr_title: "chore(release): Auto release preparation"
          pr_body: |
            ${{ steps.pr_template.outputs.template_body }}

            ---
            ## ğŸ”¥ Auto Generated Release Notes
            ${{ steps.final_notes.outputs.notes_body }}
          pr_label: "auto-release"



      # STEP 3: åˆ›å»º release/auto-release â†’ master PRï¼ˆä½ éœ€è¦çš„ï¼‰
      - name: Create PR from release/auto-release â†’ master
        uses: repo-sync/pull-request@v2
        with:
          source_branch: release/auto-release
          destination_branch: master
          github_token: ${{ secrets.GITHUB_TOKEN }}
          pr_title: "chore(release): Release â†’ master"
          pr_body:  |
            ${{ steps.pr_template.outputs.template_body }}

            ---
            ## ğŸ”¥ Auto Generated Release Notes
            ${{ steps.final_notes.outputs.notes_body }}
          pr_label: "release"